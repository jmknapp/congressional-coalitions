<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Subject Summary</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="/">
        <i class="fas fa-university me-2"></i>
        119th Congress Analysis, House of Representatives
      </a>
      <div class="navbar-nav ms-auto">
        <a class="nav-link" href="/docs"><i class="fas fa-book me-1"></i>Documentation</a>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3><i class="fas fa-tags me-2"></i>Voting by Subject</h3>
      <div>
        <a href="/" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-left me-1"></i>Dashboard</a>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label class="form-label">Scope</label>
            <select id="scope" class="form-select">
              <option value="policy_area" selected>Policy Area (broad)</option>
              <option value="subject_term">Subject Term (detailed)</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Congress</label>
            <input id="congress" type="number" class="form-control" value="119" />
          </div>
          <div class="col-md-2">
            <label class="form-label">Min Votes</label>
            <input id="minVotes" type="number" class="form-control" value="20" />
          </div>
          <div class="col-md-3">
            <div class="form-check mt-4">
              <input id="excludeProcedural" class="form-check-input" type="checkbox" checked />
              <label class="form-check-label" for="excludeProcedural">
                Exclude procedural votes
              </label>
            </div>
          </div>
          <div class="col-md-2 text-end">
            <button id="refresh" class="btn btn-primary"><i class="fas fa-sync-alt me-1"></i>Refresh</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover" id="subjects-table">
            <thead>
              <tr>
                <th>Subject</th>
                <th>D Cross %</th>
                <th>D Cross (n/N)</th>
                <th>R Cross %</th>
                <th>R Cross (n/N)</th>
                <th>Gap</th>
                <th>Votes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    async function loadSubjects() {
      const scope = document.getElementById('scope').value;
      const congress = document.getElementById('congress').value || 119;
      const minVotes = document.getElementById('minVotes').value || 20;
      const excludeProcedural = document.getElementById('excludeProcedural').checked;
      const url = `/api/subjects/summary?scope=${encodeURIComponent(scope)}&congress=${encodeURIComponent(congress)}&min_votes=${encodeURIComponent(minVotes)}&exclude_procedural=${excludeProcedural}`;

      const tbody = document.querySelector('#subjects-table tbody');
      tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">Loadingâ€¦</td></tr>';

      try {
        const resp = await fetch(url);
        const data = await resp.json();
        if (!data.items) throw new Error(data.error || 'No data');
        tbody.innerHTML = '';
        data.items.forEach(it => {
          const tr = document.createElement('tr');
          const detailUrl = `/subjects/bills?subject=${encodeURIComponent(it.subject || '')}` +
                            `&scope=${encodeURIComponent(scope)}` +
                            `&congress=${encodeURIComponent(congress)}` +
                            `&exclude_procedural=${excludeProcedural}`;
          tr.innerHTML = `
            <td>${it.subject ? `<a href="${detailUrl}">${it.subject}</a>` : '(Unknown)'}</td>
            <td>${it.d_cross_pct !== null && it.d_cross_pct !== undefined ? it.d_cross_pct.toFixed(1) + '%' : '-'}</td>
            <td>${it.d_cross ?? '-'} / ${it.d_total ?? '-'}</td>
            <td>${it.r_cross_pct !== null && it.r_cross_pct !== undefined ? it.r_cross_pct.toFixed(1) + '%' : '-'}</td>
            <td>${it.r_cross ?? '-'} / ${it.r_total ?? '-'}</td>
            <td>${it.gap !== null && it.gap !== undefined ? it.gap.toFixed(1) + '%' : '-'}</td>
            <td>${it.votes}</td>
          `;
          tbody.appendChild(tr);
        });
        if (!data.items.length) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">No subjects meet the minimum vote threshold.</td></tr>';
        }
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-danger">Failed to load: ${e.message}</td></tr>`;
      }
    }

    document.getElementById('refresh').addEventListener('click', loadSubjects);
    document.addEventListener('DOMContentLoaded', loadSubjects);
  </script>
</body>
</html>
